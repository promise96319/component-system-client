<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Previewer</title>
    <link type="text/css" rel="stylesheet" href="__QT_DESIGN_CSS_DEPENDENCY__" />
    <style>
      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      #app {
        box-sizing: border-box;
        padding: 24px;
        height: 100%;
        overflow: auto;
      }
    </style>

    <script src="http://ued.qingteng.cn:37022/library/lodash.umd.js"></script>
    <script src="http://ued.qingteng.cn:37022/library/react16.dev.umd.js"></script>
    <script src="http://ued.qingteng.cn:37022/library/react-dom16.dev.umd.js"></script>
    <script src="http://ued.qingteng.cn:37022/library/dayjs.js"></script>
    <script src="__QT_DESIGN_JS_DEPENDENCY__"></script>
  </head>

  <body>
    <div id="app"></div>

    <script type="module">
      const __modules__ = {
        react: window.React,
        'react-dom': window.ReactDOM,
        dayjs: window.dayjs,
        '@qt/design': window.QtDesign
      };

      // React 18
      // const { React, ReactDOM } = window;
      // const root = ReactDOM.createRoot(document.getElementById('app'));
      // const renderElement = (element) => {
      //   root.render(element);
      // };

      // React 16
      const root = document.getElementById('app');
      const renderElement = (element) => {
        ReactDOM.render(element, root);
      };

      const updateView = (data) => {
        const { compiledCode, error } = data;
        const createErrorComponent = (error) =>
          React.createElement(
            'div',
            {
              style: {
                whiteSpace: 'pre',
                overflow: 'auto',
                maxHeight: '100%'
              }
            },
            error.stack
          );

        if (error) {
          renderElement(createErrorComponent(error));
          return;
        }

        try {
          const req = (name) => __modules__[name];
          const Component = eval(`
          (function (require, exports) {
            ${compiledCode};
            return exports.default;
          })(${req}, {});
        `);

          if (!Component) {
            renderElement(createErrorComponent({ stack: '组件未定义，请使用 export default 导出想要渲染的组件。' }));
            return;
          }

          class CodeErrorBoundary extends window.React.Component {
            state = {
              error: null
            };

            static getDerivedStateFromError(error) {
              return { error };
            }

            render() {
              const { children } = this.props;
              const { error } = this.state;
              return error ? createErrorComponent(error) : children;
            }
          }

          renderElement(React.createElement(CodeErrorBoundary, null, React.createElement(Component)));
        } catch (err) {
          renderElement(createErrorComponent(err));
        }
      };

      window.addEventListener('message', (e) => {
        updateView(e.data);
      });
    </script>
  </body>
</html>
